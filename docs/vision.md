# Техническое видение проекта

## Технологии

- **Python** — язык программирования для разработки бота
- **uv** — инструмент для управления зависимостями Python
- **pyTelegramBotAPI (telebot)** — библиотека для интеграции с Telegram Bot API (синхронный режим работы)
- **gigachat** — официальная библиотека для работы с GigaChat API (распознавание сообщений о свободных местах)
- **make** — инструмент для автоматизации задач сборки и управления проектом

### GigaChat API

Для распознавания сообщений о свободных местах используется GigaChat API:

- **Регистрация**: на платформе [developers.sber.ru](https://developers.sber.ru/studio/login) через Сбер ID
- **Тариф**: бесплатный некоммерческий тариф (1 млн токенов в месяц)
- **Авторизация**: Client ID и Client Secret
- **Упрощение**: использование `verify_ssl_certs=False` для избежания установки корневого сертификата

## Принцип разработки

Проект разрабатывается с соблюдением следующих принципов:

- **KISS (Keep It Simple, Stupid)** — максимально простое решение без излишней сложности
- **YAGNI (You Aren't Gonna Need It)** — реализация только необходимого функционала для проверки идеи
- **MVP подход** — создание минимально жизнеспособного продукта с базовыми функциями:
  - Распознавание сообщений о свободных местах через GigaChat API
  - Отправка уведомления с кнопкой "я хочу!"
  - Сбор заявок от пользователей
  - Случайный выбор победителя через заданный интервал времени
- **Итеративная разработка** — сначала базовый функционал, затем улучшения по мере необходимости
- **Прототипирование** — быстрая реализация для проверки концепции без оверинжиниринга

## Структура проекта

```
parking-bot/
├── docs/
│   ├── idea.md
│   └── vision.md
├── src/
│   ├── bot.py              # Основной файл запуска бота
│   ├── handlers.py         # Обработчики сообщений и callback'ов
│   ├── gigachat_client.py  # Клиент для работы с GigaChat API
│   └── config.py           # Конфигурация (чтение из .env)
├── tests/
│   ├── test_handlers.py
│   ├── test_gigachat_client.py
│   └── test_config.py
├── .env.example            # Пример конфигурации
├── pyproject.toml          # Зависимости через uv
├── Makefile                # Команды для сборки и запуска
└── README.md
```

## Архитектура проекта

### Контекст работы

Бот работает в **групповом чате Telegram**, а не в личных сообщениях. Бот должен быть добавлен в группу как участник и иметь права на чтение сообщений и отправку сообщений в чат.

### Основные компоненты

1. **`bot.py`** — точка входа:
   - Инициализация бота с токеном из конфигурации
   - Регистрация обработчиков
   - Запуск polling

2. **`handlers.py`** — обработчики событий:
   - Обработчик текстовых сообщений (проверка через GigaChat)
   - Обработчик callback'ов кнопки "я хочу!"
   - Логика таймера и случайного выбора победителя
   - Управление состоянием активных розыгрышей (словарь в памяти)

3. **`gigachat_client.py`** — клиент GigaChat:
   - Метод для проверки, является ли сообщение объявлением о свободном месте
   - Возвращает булево значение или структурированный ответ

4. **`config.py`** — конфигурация:
   - Чтение переменных из `.env`
   - Предоставление настроек остальным модулям

### Поток данных

- Сообщение в чате → `handlers.py` → `gigachat_client.py` → если да, отправка уведомления с кнопкой
- Нажатие кнопки → `handlers.py` → сохранение заявки → таймер → случайный выбор → уведомление

### Управление памятью

Для предотвращения переполнения памяти реализованы следующие механизмы:

1. **Ограничение активных розыгрышей**: максимум 5 одновременных активных розыгрышей
   - При достижении лимита новые объявления игнорируются или удаляется самый старый розыгрыш

2. **Автоматическая очистка после завершения розыгрыша**: 
   - После выбора победителя запись о розыгрыше удаляется из словаря

3. **Очистка при истечении таймера**:
   - Если таймер истёк и никто не нажал кнопку — запись удаляется

## Сценарии работы

### Сценарий 1: Успешный розыгрыш

1. Пользователь пишет в чат: "место 5 сегодня свободно"
2. Бот распознаёт сообщение через GigaChat API и извлекает номер места
3. Бот отправляет сообщение: "Место свободно! Кто хочет?" с кнопкой "я хочу!"
4. Несколько пользователей нажимают кнопку
5. Через 2 минуты бот случайно выбирает одного из участников
6. Бот отправляет сообщение с упоминанием победителя: "@username, место 5 теперь за тобой!"
7. Запись о розыгрыше удаляется из памяти

### Сценарий 2: Никто не участвует

1. Пользователь пишет о свободном месте
2. Бот отправляет уведомление с кнопкой
3. Никто не нажимает кнопку
4. Через 2 минуты бот удаляет запись о розыгрыше

### Сценарий 3: Достигнут лимит активных розыгрышей

1. Уже активно 5 розыгрышей
2. Поступает новое объявление
3. Бот игнорирует его или удаляет самый старый розыгрыш

## Подход к конфигурированию

### Хранение конфиденциальных данных

Конфиденциальные данные (токены, ключи API) хранятся в файле **`.env`**:

- `TELEGRAM_BOT_TOKEN` — токен Telegram бота
- `GIGACHAT_CLIENT_ID` — Client ID для GigaChat API
- `GIGACHAT_CLIENT_SECRET` — Client Secret для GigaChat API

### Модуль конфигурации

**`config.py`** отвечает за:
- Чтение переменных из `.env` с использованием библиотеки `python-dotenv`
- Предоставление настроек остальным модулям приложения
- Настройки таймера (интервал розыгрыша, по умолчанию 2 минуты)
- Лимит активных розыгрышей (по умолчанию 5)
- Настройки GigaChat (verify_ssl_certs=False)

### Шаблон конфигурации

**`.env.example`** — шаблон файла с примерами значений (без реальных конфиденциальных данных) для удобства настройки проекта

## Подход к логгированию

### Принципы логгирования

- **Стандартный модуль `logging`** Python (без дополнительных библиотек)
- **Человекочитаемый формат**: логи должны быть понятны обычному человеку без технических знаний
- **Уровни логирования**: INFO для основных событий, ERROR для ошибок
- **Вывод**: в консоль (stdout) для простоты

### События для логирования

- Запуск/остановка бота
- Распознавание сообщения о свободном месте (с указанием номера места)
- Нажатие кнопки пользователем (с указанием username)
- Выбор победителя (с указанием username и номера места)
- Ошибки при работе с API (в понятной форме)

### Формат сообщений

Логи должны содержать понятные сообщения, например:
- "Бот запущен и готов к работе"
- "Обнаружено сообщение о свободном месте №5"
- "Пользователь @username нажал кнопку для места №5"
- "Победитель розыгрыша места №5: @username"

