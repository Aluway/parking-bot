# История изменений

Все значимые изменения в проекте документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и проект следует [Semantic Versioning](https://semver.org/lang/ru/).

## [1.0.0] - 2025-11-18

### Добавлено

#### Итерация 0: Настройка проекта
- Инициализирован проект с `uv` для управления зависимостями
- Создана структура папок (`src/`, `tests/`, `docs/`)
- Настроен `pyproject.toml` с зависимостями (pyTelegramBotAPI, gigachat, python-dotenv)
- Создан `Makefile` с базовыми командами (install, run, test, stop)
- Создан `.env.example` с шаблоном переменных окружения
- Создан `README.md` с инструкциями по установке и запуску

#### Итерация 1: Базовый бот
- Создан `src/config.py` с базовым чтением переменных из `.env`
- Создан `src/bot.py` с инициализацией Telegram бота
- Реализован простой обработчик текстовых сообщений
- Настроен запуск polling для получения обновлений
- Добавлено уведомление о успешном запуске бота

#### Итерация 2: Конфигурация
- Расширен `src/config.py` с настройками таймера розыгрыша (по умолчанию 120 секунд)
- Добавлен лимит активных розыгрышей (по умолчанию 5)
- Добавлены настройки GigaChat API (verify_ssl_certs)
- Обновлен `.env.example` со всеми переменными конфигурации

#### Итерация 3: GigaChat клиент
- Создан `src/gigachat_client.py` для работы с GigaChat API
- Реализовано подключение к GigaChat API с использованием Client Secret
- Реализован метод `check_parking_message()` для распознавания сообщений о свободных местах
- Добавлена предварительная проверка по ключевым словам (место, парков, свобод, освобод)
- Реализована обработка ошибок API с логированием

#### Итерация 4: Обработка сообщений
- Создан `src/handlers.py` для обработки сообщений и callback'ов
- Реализован обработчик текстовых сообщений `handle_text_message()`
- Интегрирован GigaChat клиент для проверки сообщений
- Реализована отправка уведомления при распознавании сообщения о свободном месте
- Убрана эхо-функциональность для непарковочных сообщений

#### Итерация 5: Кнопка и сбор заявок
- Добавлена inline-кнопка "я хочу!" к сообщению о розыгрыше
- Реализован обработчик callback'ов `handle_callback()` для обработки нажатий кнопки
- Создан словарь `active_raffles` для хранения активных розыгрышей
- Реализовано сохранение заявок пользователей (user_id) в словарь
- Добавлена проверка на дублирование участия

#### Итерация 6: Таймер и выбор победителя
- Реализован таймер (настраиваемый через `RAFFLE_TIMER_SECONDS`) для каждого розыгрыша
- Реализован случайный выбор победителя из участников с использованием `random.choice()`
- Реализована отправка сообщения с упоминанием победителя и номером места
- Добавлена обработка случая отсутствия участников

#### Итерация 7: Управление памятью
- Реализована проверка лимита активных розыгрышей перед созданием нового
- Добавлена функция `remove_oldest_raffle()` для удаления самого старого розыгрыша
- Реализована очистка розыгрышей при истечении таймера без участников
- Добавлено отслеживание timestamp для определения самого старого розыгрыша

#### Итерация 8: Логирование
- Настроен стандартный модуль `logging` с человекочитаемым форматом
- Добавлено логирование запуска/остановки бота
- Реализовано логирование распознавания места (с номером)
- Реализовано логирование нажатия кнопки (с username)
- Реализовано логирование выбора победителя (с username и номером места)
- Добавлено логирование ошибок в понятной форме

#### Итерация 9: Тесты
- Создан `tests/test_config.py` с тестами чтения конфигурации
- Создан `tests/test_gigachat_client.py` с тестами распознавания сообщений
- Создан `tests/test_handlers.py` с тестами выбора победителя и управления памятью
- Настроен запуск тестов через `make test` с использованием pytest
- Добавлен pytest в зависимости проекта

#### Безопасность
- Создан модуль `src/security.py` с функциями проверки доступа
- Реализован whitelist чатов через переменную `ALLOWED_CHAT_IDS`
- Добавлена блокировка личных сообщений (бот работает только в группах)
- Реализован контроль добавления бота в группы (только владелец может добавлять)
- Добавлена проверка прав владельца для административных команд (`/status`)
- Создан `tests/test_security.py` с тестами безопасности
- Создана документация `docs/security.md` по настройке безопасности

#### Улучшения пользовательского интерфейса
- Добавлен таймер обратного отсчета в сообщении розыгрыша (обновляется каждые 10 секунд)
- Добавлен счетчик участников на кнопке "Я хочу!" (обновляется в реальном времени)
- Добавлены эмодзи во все сообщения для улучшения визуальной навигации
- Улучшено форматирование сообщений о розыгрыше и победителе

#### Ограничения для победителей
- Реализовано ограничение: победитель не может участвовать в других активных розыгрышах
- Добавлено множество `active_winners` для отслеживания победителей
- Реализовано исключение уже выигравших из выбора победителя в параллельных розыгрышах
- Добавлена проверка при попытке участия (показывается сообщение об отказе)

#### Очистка по дням
- Добавлено хранение даты создания розыгрыша (`date`)
- Реализована функция `cleanup_old_raffles()` для удаления розыгрышей предыдущего дня
- Автоматическая очистка при создании нового розыгрыша
- Розыгрыши остаются в памяти до конца дня для отслеживания победителей

#### Автоматическое удаление сообщений
- Реализовано автоматическое удаление сообщения розыгрыша из чата после завершения
- Удаление происходит как при наличии победителя, так и при отсутствии участников
- Ошибки удаления обрабатываются корректно (если сообщение уже удалено вручную)

#### Документация
- Создан `docs/idea.md` с описанием идеи проекта
- Создан `docs/vision.md` с техническим видением проекта
- Создан `docs/conventions.md` с правилами разработки кода
- Создан `docs/tasklist.md` с пошаговым планом разработки
- Создан `docs/workflow.md` с правилами выполнения работ
- Создан `docs/security.md` с документацией по безопасности
- Создан `docs/configuration.md` с подробным описанием всех параметров конфигурации
- Обновлен `README.md` с информацией о всех функциях и возможностях

### Изменено

- Улучшена структура сообщений розыгрыша с добавлением таймера и счетчика участников
- Улучшено форматирование сообщения о победителе с эмодзи
- Обновлены ответы на действия пользователей с эмодзи для лучшей наглядности

### Исправлено

- Исправлена проблема с кодировкой в `.env.example` (использованы английские комментарии)
- Исправлена проблема с BOM в файле `.env` (пересоздан без BOM)
- Исправлена логика выбора победителя в параллельных розыгрышах (исключение уже выигравших)
- Исправлены тесты для работы с настраиваемыми значениями конфигурации

---

## Формат версионирования

Проект следует [Semantic Versioning](https://semver.org/lang/ru/):
- **MAJOR** версия - несовместимые изменения API
- **MINOR** версия - новая функциональность с обратной совместимостью
- **PATCH** версия - исправления ошибок с обратной совместимостью

## Категории изменений

- **Добавлено** - новая функциональность
- **Изменено** - изменения в существующей функциональности
- **Устарело** - функциональность, которая скоро будет удалена
- **Удалено** - удаленная функциональность
- **Исправлено** - исправления ошибок
- **Безопасность** - исправления уязвимостей

